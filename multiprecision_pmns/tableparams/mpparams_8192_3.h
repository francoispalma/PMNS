#define N 48
#define NBCHUNKS 3
#define LAMBDA 2
#define RHOver2 60

static const uint64_t RHOhi = 18976052559622037u;

static const int64_t M[3][95] = { {
		788665641756082186, 788798771203760628, 83923100793722428, 889441487055394684, 563358505850328942, 911555015636909308, 8358907173162126, 9980381659827686, 1056493876097545970, 1005334781892938934, 189471331606851896, 608434123820525624, 803379102636624064, 803445948293801792, 1141854066946065114, 35059832475846032, 141022973269153544, 884603042117043442, 974576922930600102, 754931789922425904, 680226538010334466, 675580345607172360, 229999128116479300, 284861343526670006, 988433306723169342, 1030592205013061502, 968679638490656292, 295423003953993974, 470002962112557108, 5115282190450928, 861592664534366132, 1028962246775330458, 614384259239335404, 994797381904803850, 1144164014558721502, 101655099441094368, 532665809204671552, 732989500444176528, 580499367515460592, 1014178640268041748, 509187257795783504, 155599061146479378, 718830915323951166, 504842552786406104, 845809217816146954, 578987614683566136, 370586920831787378, 382749175962115055, 970793573181464581, 970860137905303802, 41961550396861214, 1021181495831120830, 281679252925164471, 1032238260121878142, 4179453586581063, 4990190829913843, 528246938048772985, 1079128143249892955, 671196418106849436, 304217061910262812, 978150303621735520, 401722974146900896, 570927033473032557, 593990668541346504, 646972238938000260, 442301521058521721, 487288461465300051, 377465894961212952, 916574021308590721, 337790172803586180, 114999564058239650, 142430671763335003, 1070677405665008159, 1091756854809954239, 1060800571548751634, 147711501976996987, 235001481056278554, 579018393398648952, 1007257084570606554, 514481123387665229, 883652881923091190, 497398690952401925, 1148542759582784239, 50827549720547184, 842793656905759264, 366494750222088264, 866710436061153784, 507089320134020874, 831054381201315240, 77799530573239689, 359415457661975583, 828882028696626540, 999365361211496965, 865954559645206556, 761754212719317177
	}, {
		697228196403899805, 258824487422397727, 1027404632126303996, 624615334333730305, 230189951647701990, 948392232081679655, 653259100185606572, 67207476094809232, 858480273164163664, 7572002065026673, 369006795195159263, 560507094251825186, 746643995836550483, 179392574748913680, 905693931242963118, 565246517191098091, 895819152951001121, 863521095313543842, 90544421109826922, 401136332304661512, 487506793873620197, 979191745499588316, 782810821165861686, 710813154571410496, 158393494113076983, 523026642902714557, 627449421539325527, 407138250710759352, 750767838440960106, 213459605842524327, 182085837284574527, 484603947848333494, 463067310014405967, 245997491096592018, 827517354289988027, 109386844177534748, 1045329012386798993, 451520697133198532, 1002335186371982287, 490528448128771244, 765494131461463211, 704687193058169426, 77349049642383102, 634891795043625397, 996195369365194775, 1025533752515851721, 655257183525070723, 394589402616247043, 348614098201949902, 705872996014622351, 513702316063151998, 312307667166865152, 115094975823850995, 474196116040839827, 903090302396226774, 33603738047404616, 1005700888885505320, 580246753335936824, 184503397597579631, 856714299429336081, 949782750221698729, 666157039677880328, 1029307717924905047, 282623258595549045, 1024370328778924048, 431760547656771921, 621732962858336949, 777028918455754244, 820214149240233586, 1066056625053217646, 391405410582930843, 355406577285705248, 79196747056538491, 837974073754780766, 313724710769662763, 780029877658803164, 375383919220480053, 106729802921262163, 667503670945710751, 818762726227590235, 807994407310626471, 122998745548296009, 990219429448417501, 54693422088767374, 522664506193399496, 802221100870022754, 501167593185991143, 821724976367809110, 382747065730731605, 928804348832508201, 615135277124615039, 893906649825236186, 498097684682597387, 1089227628561349348, 904089344065958849
	}, {
-289497295587718, 139443328967145, 682826194752474, -744502720801390, 2041765217826824, -76226332033632, 217173943337421, -382679934160364, 717601532622423, -3576408011860177, -359387732474246, -1670935223699973, -853173832226129, -888935806535659, -1418292593833949, -404462660071662, 1779982759926673, 1362987507104222, -805347826994661, 100202249952923, -395498072800725, 309949142384267, 170440147238914, -1237830120618926, -565831615423312, -407267361456453, 2005506252157352, 1000645704640115, 89185925655226, 781797450531336, 1061816809311769, 881471244324205, -1465046862342595, 1331314574937134, -53501591518517, -519033364007594, -1007869607726890, 1236354762366647, 82289745715542, -706748838927319, 488089427881118, -1807779671061635, 102046474418673, -1033313379892191, -16618178699804, 332726465456221, -159772812493899, -190526810486032, -144748647793859, 69721664483572, 341413097376237, -372251360400695, 1020882608913412, -38113166016816, 108586971668710, -191339967080182, 358800766311211, -1788204005930089, -179693866237123, -835467611849987, -426586916113065, -444467903267830, -709146296916975, -202231330035831, 889991379963336, 681493753552111, -402673913497331, 50101124976461, -197749036400363, 154974571192133, 85220073619457, -618915060309463, -282915807711656, -203633680728227, 1002753126078676, 500322852320057, 44592962827613, 390898725265668, 530908404655884, 440735622162102, -732523431171298, 665657287468567, -26750795759259, -259516682003797, -503934803863445, 618177381183323, 41144872857771, -353374419463660, 244044713940559, -903889835530818, 51023237209336, -516656689946096, -8309089349902, 166363232728110, -79886406246950
} };

static const int64_t M1[] = {
731052045664386138, 595685090726851670, 940125628087891090, 951856920761954206, 584267574154084732, 147013886271464646, 978143098567943098, 220376025631827524, 1031222572397716560, 323900396132480288, 1012031154638238270, 416858651752138322, 325990404681898956, 241117453150214874, 323263631446605384, 99446878710900304, 922405440806954318, 344281558342053544, 546788125853206232, 467019930701525080, 1014202166521074190, 313305611190518856, 197814830530269546, 860905667695307032, 3639500463328368, 554989102822859782, 316641401804687410, 880865515801996420, 199826820860803964, 753548656152408202, 1029554010569835736, 1102080345977293422, 286564793735153602, 52024989367854060, 254378501908910500, 45227566906623110, 246267587581708764, 320647106288831726, 877907164865176776, 1061645463376119330, 399147496307632634, 108055318645726080, 294859143672240634, 910535251556534442, 224523890770241066, 61603954959102328, 232345381980225396, 998644267594013693, 941986775135616557, 874303297666849323, 1046523566347369033, 475928460380977103, 868594539380465854, 649967695439155811, 489071549283971549, 686648765119337250, 1092072038502281768, 161950198066240144, 506015577319119135, 208429325876069161, 162995202340949478, 697019478878530925, 738092568026726180, 626184191658873640, 461202720403477159, 172140779171026772, 849854815230026604, 233509965350762540, 1083561835563960583, 156652805595259428, 675368167568558261, 430452833847653516, 578280502535087672, 853955303714853379, 158320700902343705, 1016893510204421698, 99913410430401982, 953235080379627589, 514777005284917868, 551040172988646711, 143282396867576801, 602473246987350518, 127189250954455250, 599074535756735043, 123133793790854382, 736784305447839351, 1015414334736011876, 1107283483991483153, 199573748153816317, 54027659322863040, 723890324139543805, 1031728378081690709, 688722697688544021, 607262729782974652, 692633443293536186
};

static const int64_t M0m0m1[47] = { 17639733541704761, 59732067107757700, 926718088093795078, -725758491877126856, 188323709187392637, -1027122977931427214, 857413210947785069, 1023972055945416615, 86137321190562419, -84330761345089105, 472967596451872066, -202561962469168444, -445484494417063968, 331266526297275632, 9572334042428035, 420187971726695244, -137784981142216756, -286702459912042343, 231542453858651115, 127376657825193152, -70764803492443767, 241197441879979956, 255587356773547728, 240318504198780052, -99883832483543578, -120896716904650437, -1018839021151890420, 873469993854123843, 46677771868885917, 453219866723229190, -1003077630984025491, -509490932557751386, -355405943874318205, 581729452297491030, -477346341475934803, 253389512189715628, 135356646715976256, 35228223924812632, -295783402588121227, 86901348407325630, -184082142263314980, 364501990485282032, 127873003803324468, -451416133735413588, -82791339902906244, -528164386841620376, -646754648661077527 };

static const int64_t M0m0m2[47] = { 199767664967087156, 241793433809300874, 884756537696933864, -594018483101400710, -93355543737771834, -906439733446458380, 853233757361204006, 1018981865115502772, -442109616858210566, -10537399988135084, 954692682951869606, -506779024379431256, -270713293431952512, -70456447849625264, -561354699430604522, 979118807792195716, 368164284526629960, -729003980970564064, -255746007606648936, -250089237136019800, 165582679805812488, -96592730923606224, 140587792715308078, 97887832435445049, -17639733541704761, -59732067107757700, -926718088093795078, 725758491877126856, -188323709187392637, 1027122977931427214, -857413210947785069, -1023972055945416615, -86137321190562419, 84330761345089105, -472967596451872066, 202561962469168444, 445484494417063968, -331266526297275632, -9572334042428035, -420187971726695244, 137784981142216756, 286702459912042343, -231542453858651115, -127376657825193152, 70764803492443767, -241197441879979956, -255587356773547728 };

static const int64_t M1m0m1[47] = { -190220604088872919, -182846353111907794, 113747105476173529, 94830583543894200, 635672862617109111, -260736510198315500, -721004465111652247, 451000209800928878, -542633578871099353, -334249262239344806, 643013956692408396, -747327455251801333, 95546262165100264, -214636342544681796, -26972531552922760, 207905189533222199, -258876197317460837, 272926645401397505, -544383913215953847, -142137123412128847, 175981220124961189, -40522872537365925, 263851772942139880, 39182825330541795, 269417351145411411, -132101077740158415, 199977605293489235, -467722210491938012, -260288943396629058, 367466313119577664, 235586631450516023, -785158988180185619, 197706481574878849, 457248007787640815, -805716031850837870, 802020877340568707, 427118244028299233, -136064061192142426, 528140124738913904, -539101717772260065, 641623263048192443, -497043801175736280, 6597685733721910, -116877731369481942, 322116464557636199, -23171003508131702, -512683933483028006 };

static const int64_t M1m0m2[47] = { -538834702290822822, 264202155480316830, -399955210586978469, -217477083622970953, 520577886793258116, -734932626239155328, -471173262901032045, 417396471753524262, -395412963149757697, 238425489031565345, 458510559094828764, -451120250074290438, 298685016550248510, 272128122384284852, 96641255129019169, -74718069062326847, -130325021489537910, -158833902255374416, -13195371467443820, 233755462738963885, 508688575491574578, 46342007016263405, -127553637640790963, -316223751955163453, 190220604088872919, 182846353111907794, -113747105476173529, -94830583543894200, -635672862617109111, 260736510198315500, 721004465111652247, -451000209800928878, 542633578871099353, 334249262239344806, -643013956692408396, 747327455251801333, -95546262165100264, 214636342544681796, 26972531552922760, -207905189533222199, 258876197317460837, -272926645401397505, 544383913215953847, 142137123412128847, -175981220124961189, 40522872537365925, -263851772942139880 };

static const int64_t M2m0m1[47] = { -421082967629453, -476989025940025, 1664093154781115, 1372897065040810, -931696683258186, 819910616548152, 953229837643059, 1072811211404387, -1823847628653806, 3119518580867223, 126192274718606, 316434247842393, -581282691613825, 1680822665634477, 791436042632517, -504517508891488, -401901952082218, -2489273424613746, 504720387916004, -1083414504868652, 181130857700559, 177751894264088, -244992886113356, 428388249823431, 138167159917797, 273355345211799, -661340028702439, -872574212720752, 976289646085799, -429011891282484, -422321432987174, -632075589242284, 1091324197482509, -2453861293398656, -152943070477864, -575950929846190, 77347887750380, -1062645284451153, -750291169774746, 151143089427829, 645946666022777, 1585383589082929, -453697150706667, 566757814922557, -189439947050461, -11388661535977, 165106479866407 };

static const int64_t M2m0m2[47] = { -276334319835594, -546710690423598, 1322680057404878, 1745148425441505, -1952579292171598, 858023782564968, 844642865974348, 1264151178484569, -2182648394965018, 4907722586797311, 305886140955729, 1151901859692379, -154695775500761, 2125290568902306, 1500582339549491, -302286178855657, -1291893332045555, -3170767178165857, 907394301413334, -1133515629845114, 378879894100921, 22777323071954, -330212959732813, 1047303310132894, 421082967629453, 476989025940025, -1664093154781115, -1372897065040810, 931696683258186, -819910616548152, -953229837643059, -1072811211404387, 1823847628653806, -3119518580867223, -126192274718606, -316434247842393, 581282691613825, -1680822665634477, -791436042632517, 504517508891488, 401901952082218, 2489273424613746, -504720387916004, 1083414504868652, -181130857700559, -177751894264088, 244992886113356 };

static const int64_t M1_m0m1[47] = { 214574229934558787, 833607309762857435, 423039340064165353, -747984449185827659, 484153786087185086, 103580960713252391, -612439043320982789, 415431580857956172, 347414259839718810, -109925208698386084, -251637075410208635, -163201758969446051, 83272385240759286, 776549132017147777, 139814596838450596, 435461271717245690, -62055224095844525, -64085460525300692, 597925833049061006, -475896218401075074, 293883559813127459, -95048850636157100, 709898719018514111, -584730070860486799, 363706272600528885, 20347993951995944, -264718639161821648, 611956454783402381, -384240375656783104, -303267384940471778, -25705456000946319, -1017312912476156437, -204131862972142009, 712398455685736602, 378826326364663885, 762276294726181094, 39861408550095096, -39764826569308426, -277321766709285696, -481099292332609513, 261628972249660842, 118113119848163732, 125964491090482799, 354703091875918807, 394839137875416562, 702311580419131752, -17265275724977925 };

static const int64_t M1_m0m2[47] = { 425508959405789206, 1112225516702855088, 529437278323643296, -70991404959957786, 768480751313566208, -546386734725903420, 51410912001892638, -271217184261381078, 408263725944284018, -271875406764626228, 395268851877519206, -371631084845515212, -79722817100190192, 79529653138616852, -598277971188275584, -190722919941627950, 629663560107525292, -236226239696327464, -251928982180965598, -709406183751837614, 363243228856013852, -251701656231416528, 34530551449955850, 137738599898706661, -214574229934558787, -833607309762857435, -423039340064165353, 747984449185827659, -484153786087185086, -103580960713252391, 612439043320982789, -415431580857956172, -347414259839718810, 109925208698386084, 251637075410208635, 163201758969446051, -83272385240759286, -776549132017147777, -139814596838450596, -435461271717245690, 62055224095844525, 64085460525300692, -597925833049061006, 475896218401075074, -293883559813127459, 95048850636157100, -709898719018514111 };

static inline void mtoep9(__int128* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	SCHOOLBOOK(N/6)

static inline void m1toep9(int64_t* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	M1SCHOOLBOOK(N/6)


static inline void mtoep10(__int128* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	TOEP33TOP(N/2, mtoep9)

static inline void m1toep10(int64_t* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	M1TOEP33TOP(N/2, m1toep9)


static inline void toeplitz_vm(__int128* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	TOEP22TOP(N, mtoep10)

static inline void ptoeplitz_vm(__int128* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	pTOEP22TOP(N, mtoep10)

static inline void m1toep20(int64_t* restrict rop, const int64_t* restrict vect, const int64_t* restrict matr)
	M1TOEP22TOP(N, m1toep10)


static inline void mtoeplitz_vm0(__int128* restrict rop, const int64_t* restrict vect)
{
	__int128 t0[N/2], t1[N/2], t2[N/2];
	int64_t v0p1[N/2];
	for(int i = 0; i < N/2; i++)
	{
		v0p1[i] = vect[i] + vect[i + N/2];
	}
	mtoep10(t0, v0p1, M[0] + N/2);
	mtoep10(t1, vect, M0m0m1);
	mtoep10(t2, vect + N/2, M0m0m2);
	for(int i = 0; i < N/2; i++)
	{
		rop[i] = t0[i] - t2[i];
		rop[i + N/2] = t0[i] - t1[i];
	}
}


static inline void mtoeplitz_vm1(__int128* restrict rop, const int64_t* restrict vect)
{
	__int128 t0[N/2], t1[N/2], t2[N/2];
	int64_t v0p1[N/2];
	for(int i = 0; i < N/2; i++)
	{
		v0p1[i] = vect[i] + vect[i + N/2];
	}
	mtoep10(t0, v0p1, M[1] + N/2);
	mtoep10(t1, vect, M1m0m1);
	mtoep10(t2, vect + N/2, M1m0m2);
	for(int i = 0; i < N/2; i++)
	{
		rop[i] = t0[i] - t2[i];
		rop[i + N/2] = t0[i] - t1[i];
	}
}


static inline void mtoeplitz_vm2(__int128* restrict rop, const int64_t* restrict vect)
{
	__int128 t0[N/2], t1[N/2], t2[N/2];
	int64_t v0p1[N/2];
	for(int i = 0; i < N/2; i++)
	{
		v0p1[i] = vect[i] + vect[i + N/2];
	}
	mtoep10(t0, v0p1, M[2] + N/2);
	mtoep10(t1, vect, M2m0m1);
	mtoep10(t2, vect + N/2, M2m0m2);
	for(int i = 0; i < N/2; i++)
	{
		rop[i] = t0[i] - t2[i];
		rop[i + N/2] = t0[i] - t1[i];
	}
}


// Utility function to extract the lower 64 bits of each vector coefficient
static inline void m1toeplitz_vm(int64_t* restrict rop, const __int128* restrict vect)
{
	int64_t t0[N/2], t1[N/2], t2[N/2];
	int64_t v0p1[N/2], v[N];
	for(int i = 0; i < N/2; i++)
	{
		v[i] = vect[i];
		v[i + N/2] = vect[i + N/2];
		v0p1[i] = v[i] + v[i + N/2];
	}
	m1toep10(t0, v0p1, M1 + N/2);
	m1toep10(t1, v, M1_m0m1);
	m1toep10(t2, v + N/2, M1_m0m2);
	for(int i = 0; i < N/2; i++)
	{
		rop[i] = t0[i] - t2[i];
		rop[i + N/2] = t0[i] - t1[i];
	}
}

void (* const multbym[3]) (__int128* restrict rop, const int64_t* restrict vect) = { mtoeplitz_vm0, mtoeplitz_vm1, mtoeplitz_vm2 };

